# Scratch課題一括確認ツール 追加検証・対応整理

## プロジェクト状況
- **進捗**: 一覧・詳細・コード閲覧まで一通り操作可能なプロトタイプを保持しつつ、大量 `.sb3` 読み込み時の問題とScratch公式モジュール移行課題を整理中。
- **検証テーマ**: WebGLコンテキスト制限に伴うステージ消失、`scratch-blocks`/`scratch-storage` の動的ロード対応、`@scratch` 系mono-repo版への移行検討。

## 追加更新サマリ（2025-10-24以降）
- コード確認モーダル向けに `scratch-blocks` をグローバルスクリプトとして動的読み込み (`src/utils/loadScratchBlocks.ts:1`)。
- `public/chunks/` 配下に `scratch-storage` の fetch-worker を配置し、Workerロードエラーを解消。
- WebGLコンテキスト上限到達による警告・描画崩れを確認し、対策案を整理。
- Scratch公式が提供するmono-repo版(`@scratch/scratch-vm` 等)未移行であることを明示し、移行検討の必要性を整理。

## 現状把握
- 一覧カードは`ScratchStage`でWebGLコンテキストを消費。大量表示でブラウザ上限に達し、古いステージが破棄される (`Too many active WebGL contexts`)。
- コード確認モーダルは、対象プロジェクトごとにVMを初期化してXML変換し、`scratch-blocks` のワークスペースに反映。初回ロードで遅延が発生。
- 依存パッケージは旧単体リポジトリ版 (`scratch-vm@5.0.300` など)。mono-repo版とのAPI差異調査は未着手。

## 課題・対応方針
1. **WebGLコンテキスト管理**
   - 一覧カードでは静止サムネイル描画や仮想化を検討し、アクティブステージ数を制限する。
   - `ScratchStage` に `active` フラグ等を導入し、必要なときのみ `ScratchRender` を初期化・利用後に`dispose()` + `WEBGL_lose_context` を呼ぶ設計を検討。
   - 一括再生時は同時起動数を上限管理し、キュー制御を行う。
2. **コードモーダル最適化**
   - `scratch-blocks` のローカライズやZoom設定を調整し、日本語UIへの拡張・性能検証を継続。
   - VMロードのキャッシュ・先読み・表示切替時のスムーズ化を検討。
3. **モジュール移行検討**
   - `@scratch/scratch-vm` を含むmono-repo版の導入手順、API差分、ライセンス確認を実施。
   - 旧モジュールで報告済みの修正/課題がmono-repoで解消されているか調査。
4. **UX拡張余地**
   - 採点メモ入力UI、一覧検索フィルタ、ステージプレビュー切替など将来機能の検討余地を残す。

## 次アクション案
1. WebGLコンテキスト共有・遅延初期化の試作と同時表示可能数のベンチマーク取得。
2. `@scratch/scratch-vm` 版を別ブランチで試験導入し、ビルド/動作差異を評価。
3. コードモーダルの読み込みログ収集（時間計測）とローカライズ対応プラン策定。
4. 採点メモUIの要件ヒアリングとUIプロトタイプ設計。
