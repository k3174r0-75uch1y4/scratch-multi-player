# Scratch課題一括確認ツール 要件定義（2025-10-25 更新版）

## 1. プロジェクト概要
- **目的**: 講師が複数 `.sb3` を一括で確認・採点できるブラウザベースの補助ツールを提供する。授業単位で提出された Scratch プロジェクトの動作・コードを短時間で俯瞰する。
- **最新状況**: プロトタイプで一覧表示／個別詳細表示／コード閲覧（日本語ブロック表示）を実現。大量読み込み時の WebGL リソース制御や Scratch モジュール移行を検証中。

## 2. 運用前提・対象環境
- `.sb3` ファイルは授業ごとにローカル保存したものを一括選択して読み込む。
- 追加クラウド連携は現時点で未実装（将来拡張余地あり）。
- 推奨実行環境: Google Chrome 最新版（Mac/Windows 共通）。ワークステーション上での起動を想定。
- 利用者: 採点担当講師。Scratch プロジェクトに慣れていることを前提とする。

## 3. 実装済み機能
1. **ファイル読み込み管理**
   - `.sb3` 複数選択で一覧に追加（デフォルト上限 15 件、ブラウザ設定を変更した場合はトグルで制限解除）。
   - 上限超過時は警告ポップアップで再選択を促す。
2. **一覧表示（React / Scratch VM）**
   - ステージ・ファイル名・更新日時をカードで表示。
   - カード単位の「個別再生」「停止」「詳細表示」「コード確認」ボタンを提供。
   - 全カードの WebGL コンテキストをアクティブ状態に応じて管理し、詳細モーダル表示中は一覧側ステージを一時停止してコンテキストを節約。
3. **一括操作**
   - 一括再生／一括停止で読み込み済み全カードに緑の旗相当のイベントを送信。
4. **詳細モーダル**
   - ステージ拡大表示（サイズ自動調整）・個別再生／停止ボタン。
   - プロジェクト構成サマリ（スプライト数、ブロック数、変数等）をテーブル表示。
   - モーダルを閉じる際に WebGL コンテキストを確実に `dispose` して一覧側のコンテキスト喪失を防止。
5. **コード確認モーダル**
   - `scratch-blocks` ワークスペースを読み込み、スプライト／背景ごとのブロックをタブ切り替えで閲覧。
   - `scratch-l10n`・`scratch-blocks/msg/scratch_msgs` を併せて読み込み、日本語ブロック表示に対応。
   - VM から `Blocks.toXML()` で抽出した XML を読み込み、中心表示・ズーム機能を提供。
6. **サウンド／キーボード制御**
   - 一覧カードをクリックするとアクティブカードが切り替わり、当該カードのみサウンド出力・キーボード入力を受け付ける。

## 4. 未実装・検討中の機能
| 項目 | 現状 | 検討内容 |
| --- | --- | --- |
| 採点メモ機能 | 未実装 | 一覧カードに評価メモ・スコアを記録する UI と保存方式の検討 |
| 検索／フィルタ | 未実装 | スプライト名や動作ラベルでフィルタリングする機能 |
| オフラインサムネイル生成 | 未実装 | WebGL コンテキスト節約のための静止画生成方式 |

## 5. 非機能要件
### 5.1 パフォーマンス・リソース
- Chrome のデフォルト WebGL コンテキスト上限（約 16）を超えないよう、詳細表示中は一覧カードのコンテキストを停止。必要に応じてブラウザ起動オプションで上限変更を案内。
- サウンドおよびキーボード入力はアクティブカードのみ処理して CPU/メモリ負荷を軽減。
- `.sb3` 読み込み／解析時はエラーを日本語で表示し異常終了を防止。

### 5.2 UX / UI
- 操作ガイドや注意事項（例: 上限 15 件）を画面下部に常時表示。
- 詳細モーダル／コード閲覧モーダルは表示時のみ初期化し、閉じる際にリソースを解放する。
- ブロック表示は公式 Scratch に近い日本語表記で統一。

## 6. 技術構成（2025-10 現在）
- **言語・フレームワーク**: Node.js 24.1.0 / Vite 7.1.7 / React 19.1.1 / TypeScript 5.9.3
- **Scratch 関連ライブラリ**: `scratch-vm`, `scratch-render`, `scratch-storage`, `scratch-svg-renderer`, `scratch-audio`, `scratch-blocks`, `scratch-l10n`
- **その他**: `jszip`, `uuid`, `events`, `gh-pages`
- **損益レポート**: （なし）

## 7. リスクと課題
1. **WebGL コンテキスト上限**  
   - 15 件＋詳細モーダルで上限に達しやすいため、残り 1 枠分を想定しつつ詳細モーダルでのコンテキスト解放を徹底。将来的にはオフスクリーン描画や静止サムネイルを検討。
2. **Mono-repo 版 Scratch モジュールへの移行**  
   - 現状 `@scratch/scratch-vm` 等の最新版には移行しておらず、旧パッケージを利用している。移行時には API 互換性とビルド設定の再検証が必要。
3. **大量入力時のパフォーマンス**  
   - `.sb3` 一括解析で CPU やメモリが増大する可能性。読み込みの逐次化／並列数制御が今後の課題。
4. **UI 拡張性**  
   - 教員向けメモ入力・項目ソートなど拡張機能を見越したコンポーネント再設計が必要。

## 8. 追加検証ログ（要点）
- WebGL 上限到達時に一覧カードが破棄される現象を確認し、詳細表示中にカードプレビューを停止＋モーダルクローズ時に `renderer.dispose()`＋`vm.stopAll()`＋サウンド/キーボードリリースを実施。
- コード確認モーダルの英語ブロック表示を日本語化。`scratch-blocks/msg/scratch_msgs.js` のロードと `ScratchMsgs.setLocale('ja')` を追加。
- 詳細モーダルのステージサイズを固定（320x240）しスクロール無しで再生ボタンを配置。閉じる／アンマウント時に必ず `dispose` を呼び出す。

## 9. 次の具体的ステップ
1. **Scratch モジュールの Mono-repo 版への対応検証**  
   - `@scratch/scratch-vm` などへの置き換え手順・差分を調査し、別ブランチで試験。
2. **WebGL コンテキスト戦略の高度化**  
   - オフスクリーン描画や WebGL コンテキストプーリング実験、静止画サムネイル採用など。
3. **採点支援 UI の拡張**  
   - メモ欄やスコアリング UI、タスク分類タグなどを設計。
4. **GitHub Pages デプロイの自動化**  
   - `gh-pages` スクリプトを利用したデプロイフローの整備と CI/CD 連携。
