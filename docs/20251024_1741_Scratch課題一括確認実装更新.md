# Scratch課題一括確認ツール 実装更新レポート（2025-10-24 16:35）

## プロジェクト状況
- **進捗**: マルチ `.sb3` 読み込み〜一覧再生・詳細確認まで動作するプロトタイプを実装し、授業での採点作業を想定した検証段階に移行。
- **ネクストステップ**: ブロック編集ビューの再現と評価入力UI追加に向けた設計・ライブラリ選定、および複数VM同時実行時のパフォーマンス測定。

## 更新サマリ
- 一括読み込みした `.sb3` のステージをReact上で一覧表示し、個別/一括の再生制御・詳細閲覧を提供する画面へ刷新。
- Scratch公式モジュール群 (`scratch-vm` ほか) を導入し、ブラウザ環境に対応した初期化・エラーハンドリングを整備。
- 詳細モーダルでブロック構成の概要を自動集計し、将来のブロック編集ビュー拡張に備えたデータ取得処理を実装。
- CJS/ESM差異やNode依存モジュールを吸収する動的ローディングとポリフィルを導入し、ブラウザ実行時の例外を解消。
- コード確認モーダルを追加し、背景・スプライト単位のブロック構成を `scratch-blocks` ベースで閲覧可能にした。

## 実装詳細
- **UI/機能**: `src/App.tsx:9` で `.sb3` ファイル群を読み込み一覧を生成し、一括再生・停止・クリア操作を提供。`src/components/ScratchProjectCard.tsx:26` と連携し各ステージの個別再生や詳細表示を制御。
- **ステージ再生**: `src/components/ScratchStage.tsx:34` に Scratch VM プレイヤーを実装。レンダラー/ストレージ/オーディオ/拡張アダプタを初期化し、状態変化と日本語メッセージによるエラー通知を行う。
- **詳細ビュー**: `src/components/ProjectDetailModal.tsx:24` で拡大ステージと再生制御、`src/utils/projectParser.ts:19` で抽出したターゲット別統計テーブルを表示。将来のブロック閲覧拡張に備えた構造化データを保持。
- **コード確認ビュー**: `src/components/CodeViewerModal.tsx:16` で `scratch-blocks` ワークスペースを動的生成し、ステージ・スプライトをタブ切替で表示。`loadScratchModules` 共有化による動的インポートと `Blocks.toXML` のXML生成でブロック構成を復元。
- **型・スタイル整備**: `src/types/project.ts:1` でロード済みプロジェクト型を定義し、`src/App.css` と `src/index.css` を授業向けUIに合わせて整形。

## 技術的対応
- **依存導入**: `package.json` に `scratch-vm` / `scratch-render` / `scratch-storage` / `scratch-svg-renderer` / `scratch-audio` / `scratch-render-fonts` / `jszip` / `events` などを追加し、Vite + React + TypeScript 環境に統合。
- **Node依存の解消**: `vite.config.ts:5` で `events` をブラウザ向けポリフィルへエイリアスし、`optimizeDeps` に追加してビルド時の外部化警告を抑止。
- **モジュール互換**: CommonJS / ESM 差異により `ScratchStorage` 等が未定義になる問題を踏まえ、`ScratchStage.tsx:60` で `pickConstructor` を用いたコンストラクタ検出と `import()` ベースの動的ローディング (`loadScratchModules`) を実装。モジュール取得後にVMを初期化し、リスナーの一元解放 (`cleanupListeners`) を行う。
- **メタ解析**: `src/utils/projectParser.ts:19` で `JSZip` を用いて `project.json` を解析し、ターゲット単位のブロック/変数/リスト/メッセージ等を集計。
- **共通モジュール化**: `src/utils/scratchModules.ts:1` に Scratch 公式ライブラリ読込処理を集約し、ステージ表示とコードビューで再利用。
- **アセット提供**: `public/scratch-blocks-media/` に `scratch-blocks` のメディア資産を配置し、ブロック描画に必要なアイコン・音源をローカル提供。
- **ワーカー/スクリプト配信**: `public/chunks/` に `scratch-storage` のFetchワーカーを配置し、`src/utils/loadScratchBlocks.ts:1` で `scratch-blocks` のビルド済みスクリプトを動的ロードしてブラウザ互換性を確保。

## ビルド・確認
- 実行コマンド: `npm run build`
- 成果: Viteビルドが成功し、Scratch関連モジュールは動的チャンクに分割。`npm run preview` でブラウザ確認済み。

## 留意事項
- 詳細モーダルはブロック集計のみで、Scratch Blocks 互換UIは未実装。（コード確認モーダル側で閲覧機能を提供）
- Scratchモジュール依存によりバンドルサイズが約10MBと大きく、Viteからチャンクサイズ警告が出る。必要に応じて遅延ロードや `manualChunks` の導入を検討。
- `ScratchStage` 初回読み込み時はモジュール取得待機が発生するため、ローディングUIの充実やエラーバウンダリ導入を今後検討。
- コード確認モーダルは読み込み時にVM初期化を行うため、表示開始まで数秒要する場合がある。事前ローディングやキャッシュ戦略を検討。

## 今後の対応候補
1. コード確認モーダルのパフォーマンス最適化と日本語ローカライズ対応（ラベル・メッセージ追加）。
2. 複数VM同時再生時のパフォーマンス測定と最大同時起動数の制御ロジック検討。
3. 採点メモ・評価フォームなど教員向け入力UIの追加と保存方式の検討。
